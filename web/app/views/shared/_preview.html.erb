<%
# this is a general preview shared view. Hand in the text that should
# be previewed as a local variable, like this:
#    render "shared/preview", :text => TEXT
%>

<% cache("preview_#{params[:controller]}_#{params[:id]}") do %>
  <%
    failed, exitcodes, error, base64 = texpreview(text)
    is_img = !failed && !base64.blank?
  %>

  <%# required for properly previewing in form editor %>
  <%= "<div>".html_safe unless is_img %>

  <% if failed || base64.nil? %>
    <span class="error">An error occurred while rendering the preview. Most likely, you have a typo in the TeX code somewhere. Scroll down to see what TeX has to say about this.</span><br/><br/>
    EXIT CODES: <%= exitcodes.join(", ") %>
    <br/><div class="pre"><%= error.html_safe %></div>
  <% end %>

  <% if !base64.nil? && base64.empty? %>
    <span class="info">Nothing to display.</span>
  <% end %>

  <%= "</div>".html_safe unless is_img %>

  <%= %(<img class="no-shadow" src="data:image/png;base64,#{base64}"/>).html_safe if is_img %>
<% end %>
